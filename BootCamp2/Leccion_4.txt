üìò Lecci√≥n 4 ‚Äî Inicio de sesi√≥n (validaci√≥n de credenciales + sesi√≥n)

Parte A ‚Äî C√≥digo limpio (iniciar_sesion.php)

<?php
require_once "conexion.php";

$mensaje = "";

if ($_SERVER["REQUEST_METHOD"] === "POST") {
    $correo     = trim($_POST["correo"] ?? "");
    $contrasena = $_POST["contrasena"] ?? "";

    if ($correo === "" || $contrasena === "") {
        $mensaje = "Ingresa tu correo y tu contrase√±a.";
    } else {
        $sql = "SELECT id, nombre, correo, contrasena_hash
                FROM usuarios
                WHERE correo = ?";
        $sentencia = $conexion->prepare($sql);

        if ($sentencia) {
            $sentencia->bind_param("s", $correo);
            $sentencia->execute();
            $resultado = $sentencia->get_result();

            if ($resultado && $resultado->num_rows === 1) {
                $usuario = $resultado->fetch_assoc();

                if (password_verify($contrasena, $usuario["contrasena_hash"])) {
                    $_SESSION["usuario_id"]     = $usuario["id"];
                    $_SESSION["usuario_nombre"] = $usuario["nombre"];
                    $_SESSION["usuario_correo"] = $usuario["correo"];

                    header("Location: privado.php");
                    exit;
                } else {
                    $mensaje = "Contrase√±a incorrecta.";
                }
            } else {
                $mensaje = "No existe una cuenta con ese correo.";
            }

            $sentencia->close();
        } else {
            $mensaje = "Error al preparar la consulta: " . $conexion->error;
        }
    }
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Iniciar sesi√≥n</title>
  <link rel="stylesheet" href="estilo.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <h1>Iniciar sesi√≥n</h1>

  <?php if ($mensaje !== ""): ?>
    <p class="mensaje"><?= htmlspecialchars($mensaje) ?></p>
  <?php endif; ?>

  <form method="post" action="iniciar_sesion.php" novalidate>
    <label for="correo">Correo</label>
    <input id="correo" name="correo" type="email" required maxlength="120" autocomplete="email">

    <label for="contrasena">Contrase√±a</label>
    <input id="contrasena" name="contrasena" type="password" required minlength="6" autocomplete="current-password">

    <button type="submit">Entrar</button>
  </form>

  <p>¬øNo tienes cuenta? <a href="registrar.php">Reg√≠strate</a></p>
</body>
</html>

Parte B ‚Äî Explicaci√≥n detallada l√≠nea por l√≠nea

Bloque PHP
	‚Ä¢	<?php
Marca el inicio del c√≥digo PHP.
	‚Ä¢	require_once "conexion.php";
Incluye una √∫nica vez el archivo de conexi√≥n. Provee $conexion y una sesi√≥n iniciada.
	‚Ä¢	$mensaje = "";
Crea una variable de texto vac√≠a para mostrar retroalimentaci√≥n.
	‚Ä¢	if ($_SERVER["REQUEST_METHOD"] === "POST") {
Comprueba el m√©todo HTTP de la solicitud. Solo procesa si el formulario fue enviado por POST.
	‚Ä¢	$correo     = trim($_POST["correo"] ?? "");
Lee el valor de correo del env√≠o. Si no existe la clave, usa "".
La funci√≥n trim() recorta espacios en blanco al inicio y al final.
	‚Ä¢	$contrasena = $_POST["contrasena"] ?? "";
Lee la contrase√±a tal cual fue escrita. Si no existe, usa "".
	‚Ä¢	if ($correo === "" || $contrasena === "") {
Valida que ambos campos tengan contenido. El operador || significa ‚Äúo‚Äù.
	‚Ä¢	$mensaje = "Ingresa tu correo y tu contrase√±a.";
Asigna texto de error para campos vac√≠os.
	‚Ä¢	$sql = "SELECT id, nombre, correo, contrasena_hash FROM usuarios WHERE correo = ?";
Declara consulta SQL con un marcador ? para usar una sentencia preparada.
	‚Ä¢	$sentencia = $conexion->prepare($sql);
Solicita al servidor que prepare la consulta. Devuelve un objeto mysqli_stmt o false.
	‚Ä¢	if ($sentencia) {
Comprueba que la preparaci√≥n no fall√≥.
	‚Ä¢	$sentencia->bind_param("s", $correo);
Enlaza el par√°metro al marcador. "s" indica string.
	‚Ä¢	$sentencia->execute();
Ejecuta la sentencia preparada en el servidor.
	‚Ä¢	$resultado = $sentencia->get_result();
Obtiene un mysqli_result con las filas devueltas por la consulta.
	‚Ä¢	if ($resultado && $resultado->num_rows === 1) {
Verifica que lleg√≥ exactamente una fila para ese correo.
	‚Ä¢	$usuario = $resultado->fetch_assoc();
Convierte la fila en arreglo asociativo: claves iguales a los nombres de columna.
	‚Ä¢	if (password_verify($contrasena, $usuario["contrasena_hash"])) {
Compara la contrase√±a en texto con el hash almacenado usando password_verify.
	‚Ä¢	$_SESSION["usuario_id"] = $usuario["id"];
Guarda el identificador del usuario en la sesi√≥n.
	‚Ä¢	$_SESSION["usuario_nombre"] = $usuario["nombre"];
Guarda el nombre del usuario en la sesi√≥n.
	‚Ä¢	$_SESSION["usuario_correo"] = $usuario["correo"];
Guarda el correo del usuario en la sesi√≥n.
	‚Ä¢	header("Location: privado.php");
Env√≠a una cabecera HTTP de redirecci√≥n al navegador para cargar privado.php.
	‚Ä¢	exit;
Detiene la ejecuci√≥n tras enviar la redirecci√≥n.
	‚Ä¢	else { $mensaje = "Contrase√±a incorrecta."; }
Mensaje de error cuando la verificaci√≥n de contrase√±a falla.
	‚Ä¢	else { $mensaje = "No existe una cuenta con ese correo."; }
Mensaje cuando la b√∫squeda por correo no devolvi√≥ ninguna fila.
	‚Ä¢	$sentencia->close();
Libera recursos de la sentencia preparada.
	‚Ä¢	else { $mensaje = "Error al preparar la consulta: " . $conexion->error; }
Mensaje cuando prepare() no pudo construirse en el servidor.

Bloque HTML
	‚Ä¢	<!DOCTYPE html>
Declara HTML5.
	‚Ä¢	<html lang="es">
Documento en espa√±ol.
	‚Ä¢	<meta charset="UTF-8">
Codificaci√≥n UTF-8 para caracteres acentuados.
	‚Ä¢	<title>Iniciar sesi√≥n</title>
T√≠tulo de la pesta√±a.
	‚Ä¢	<link rel="stylesheet" href="estilo.css">
Carga la hoja de estilos.
	‚Ä¢	<meta name="viewport" content="width=device-width, initial-scale=1">
Adaptaci√≥n a pantallas m√≥viles.
	‚Ä¢	<h1>Iniciar sesi√≥n</h1>
Encabezado principal.
	‚Ä¢	<?php if ($mensaje !== ""): ?> ... <?php endif; ?>
Bloque condicional que imprime el p√°rrafo con el mensaje si existe texto.
	‚Ä¢	<form method="post" action="iniciar_sesion.php" novalidate>
Formulario que env√≠a por POST al mismo archivo. novalidate evita bloqueos de validaci√≥n nativa en demos.
	‚Ä¢	<input id="correo" name="correo" type="email" ...>
Campo de correo. type="email" agrega validaci√≥n b√°sica y teclado adecuado en m√≥viles.
	‚Ä¢	<input id="contrasena" name="contrasena" type="password" ...>
Campo de contrase√±a. minlength="6" fija un m√≠nimo local.
	‚Ä¢	<button type="submit">Entrar</button>
Env√≠a datos al servidor.
	‚Ä¢	<a href="registrar.php">Reg√≠strate</a>
Enlace para ir al registro si no tiene cuenta.

üéØ Comprobaci√≥n r√°pida
	1.	Crea un usuario desde registrar.php.
	2.	Abre http://localhost/proyecto_crud/iniciar_sesion.php.
	3.	Prueba con correo y contrase√±a correctos: debe llevarte a privado.php.
	4.	Prueba contrase√±a err√≥nea: debe mostrar ‚ÄúContrase√±a incorrecta.‚Äù
	5.	Prueba un correo inexistente: debe mostrar ‚ÄúNo existe una cuenta con ese correo.‚Äù
